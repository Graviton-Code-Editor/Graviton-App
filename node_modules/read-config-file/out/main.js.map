{"version":3,"sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["import {readFile, readJson} from \"fs-extra-p\"\nimport {safeLoad} from \"js-yaml\"\nimport * as path from \"path\"\nimport {Lazy} from \"lazy-val\"\nimport Ajv, {ErrorObject} from \"ajv\"\nimport {normaliseErrorMessages} from \"./ajvErrorNormalizer\"\nimport {parse as parseEnv} from \"dotenv\"\n\nexport interface ReadConfigResult<T> {\n  readonly result: T\n  readonly configFile: string | null\n}\n\nasync function readConfig<T>(configFile: string, request: ReadConfigRequest): Promise<ReadConfigResult<T>> {\n  const data = await readFile(configFile, \"utf8\")\n  let result\n  if (configFile.endsWith(\".json5\") || configFile.endsWith(\".json\")) {\n    result = require(\"json5\").parse(data)\n  }\n  else if (configFile.endsWith(\".js\")) {\n    result = require(configFile)\n    if (result.default != null) {\n      result = result.default\n    }\n    if (typeof result === \"function\") {\n      result = result(request)\n    }\n    result = await Promise.resolve(result)\n  }\n  else if (configFile.endsWith(\".toml\")) {\n    result = require(\"toml\").parse(data)\n  }\n  else {\n    result = safeLoad(data)\n  }\n  return {result, configFile}\n}\n\nexport async function findAndReadConfig<T>(request: ReadConfigRequest): Promise<ReadConfigResult<T> | null> {\n  const prefix = request.configFilename\n  for (const configFile of [`${prefix}.yml`, `${prefix}.yaml`, `${prefix}.json`, `${prefix}.json5`, `${prefix}.toml`, `${prefix}.js`]) {\n    const data = await orNullIfFileNotExist(readConfig<T>(path.join(request.projectDir, configFile), request))\n    if (data != null) {\n      return data\n    }\n  }\n\n  return null\n}\n\nexport function orNullIfFileNotExist<T>(promise: Promise<T>): Promise<T | null> {\n  return orIfFileNotExist(promise, null)\n}\n\nexport function orIfFileNotExist<T>(promise: Promise<T>, fallbackValue: T): Promise<T> {\n  return promise\n    .catch(e => {\n      if (e.code === \"ENOENT\" || e.code === \"ENOTDIR\") {\n        return fallbackValue\n      }\n      throw e\n    })\n}\n\nexport interface ReadConfigRequest {\n  packageKey: string\n  configFilename: string\n\n  projectDir: string\n  packageMetadata: Lazy<{ [key: string]: any } | null> | null\n}\n\nexport async function loadConfig<T>(request: ReadConfigRequest): Promise<ReadConfigResult<T> | null> {\n  let packageMetadata = request.packageMetadata == null ? null : await request.packageMetadata.value\n  if (packageMetadata == null) {\n    packageMetadata = await orNullIfFileNotExist(readJson(path.join(request.projectDir, \"package.json\")))\n  }\n\n  const data: T = packageMetadata == null ? null : packageMetadata[request.packageKey]\n  return data == null ? findAndReadConfig<T>(request) : {result: data, configFile: null}\n}\n\nexport function getConfig<T>(request: ReadConfigRequest, configPath?: string | null): Promise<ReadConfigResult<T> | null> {\n  if (configPath == null) {\n    return loadConfig<T>(request)\n  }\n  else {\n    return readConfig<T>(path.resolve(request.projectDir, configPath), request)\n  }\n}\n\nexport async function loadParentConfig<T>(request: ReadConfigRequest, spec: string): Promise<ReadConfigResult<T>> {\n  let isFileSpec: boolean | undefined\n  if (spec.startsWith(\"file:\")) {\n    spec = spec.substring(\"file:\".length)\n    isFileSpec = true\n  }\n\n  let parentConfig = await orNullIfFileNotExist(readConfig<T>(path.resolve(request.projectDir, spec), request))\n  if (parentConfig == null && isFileSpec !== true) {\n    let resolved: string | null = null\n    try {\n      resolved = require.resolve(spec)\n    }\n    catch (e) {\n      // ignore\n    }\n\n    if (resolved != null) {\n      parentConfig = await readConfig<T>(resolved, request)\n    }\n  }\n\n  if (parentConfig == null) {\n    throw new Error(`Cannot find parent config file: ${spec}`)\n  }\n\n  return parentConfig\n}\n\nexport async function validateConfig(config: any, scheme: Lazy<any>, errorMessage: (error: string, errors: Array<ErrorObject>) => string) {\n  const ajv = new Ajv({\n    allErrors: true,\n    coerceTypes: true,\n    verbose: true,\n    errorDataPath: \"configuration\",\n  })\n  require(\"ajv-keywords\")(ajv, [\"typeof\"])\n  const schema = await scheme.value\n  const validator = ajv.compile(schema)\n\n  if (!validator(config)) {\n    const error = new Error(errorMessage(normaliseErrorMessages(validator.errors!, schema), validator.errors!!));\n    (error as any).code = \"ERR_CONFIG_INVALID\"\n    throw error\n  }\n}\n\nexport async function loadEnv(envFile: string) {\n  const data = await orNullIfFileNotExist(readFile(envFile, \"utf8\"))\n  if (data == null) {\n    return null\n  }\n\n  const parsed = parseEnv(data)\n  for (const key of Object.keys(parsed)) {\n    if (!process.env.hasOwnProperty(key)) {\n      process.env[key] = parsed[key]\n    }\n  }\n  require(\"dotenv-expand\")(parsed)\n  return parsed\n}"],"sourceRoot":""}
